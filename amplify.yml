version: 1
frontend:
  phases:
    preBuild:
      commands:
        - 'nvm use 22'
        - 'npm i -g bun'
        - 'bun i'
        # Branch-specific environment detection
        - |
          echo "=== Environment Detection ==="
          echo "AWS_BRANCH variable: '$AWS_BRANCH'"
          echo "Git branch: $(git branch --show-current || echo 'unknown')"

          # Determine the branch (try AWS_BRANCH first, then git)
          BRANCH="${AWS_BRANCH:-$(git branch --show-current)}"
          # Trim whitespace and convert to lowercase for comparison
          BRANCH=$(echo "$BRANCH" | xargs | tr '[:upper:]' '[:lower:]')
          echo "Normalized branch: '$BRANCH'"

          # List available .env files for debugging
          echo "Available .env files:"
          ls -la .env* 2>/dev/null || echo "No .env files found"

          echo "=== Build Mode Selection ==="
          if [ "$BRANCH" = "production" ]; then
            echo "✓ Will build in production mode (uses .env.production)"
          elif [ "$BRANCH" = "staging" ]; then
            echo "✓ Will build in staging mode (uses .env.staging)"
          else
            echo "⚠ Unknown branch '$BRANCH', will use default mode"
          fi
    build:
      commands:
        - 'echo "=== Starting Build Phase ==="'
        - 'echo "Branch is $AWS_BRANCH"'
        - 'npx vite build --mode $AWS_BRANCH'
        - 'echo "=== Build Complete ==="'
        - 'ls -lh dist/ | head -10 || echo "dist directory not found"'
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
